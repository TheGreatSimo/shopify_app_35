{% assign productId = 'rentable-gid://shopify/Product/' | append: product.id %}
{% assign rentSettings = app.metafields[productId].rentSettings.value  %}

{%  if rentSettings != blank %}
  {% assign settings = rentSettings %}
  {% if settings.isRentalEnabled %}
    
    <div class="rental-section" style="margin: 20px 0;">
      <button 
        id="rental-btn-{{ product.id }}" 
        class="rental-button"
        style="background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s;"
        onmouseover="this.style.background='#1d4ed8'" 
        onmouseout="this.style.background='#2563eb'"
      >
        Rent Now
      </button>
    </div>

    <div id="rental-modal-{{ product.id }}" class="rental-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
        <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 600; text-align: center;">Rent {{ product.title }}</h3>
        
        <div style="margin-bottom: 20px;">
          <label for="rental-days-{{ product.id }}" style="display: block; margin-bottom: 8px; font-weight: 500;">Number of days:</label>
          <input 
            type="number" 
            id="rental-days-{{ product.id }}"
            min="{{ settings.minDays }}" 
            max="{{ settings.maxDays }}" 
            value="{{ settings.minDays }}"
            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;"
          >
          <small style="color: #6b7280; margin-top: 5px; display: block;">Min: {{ settings.minDays }} days, Max: {{ settings.maxDays }} days</small>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 6px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Daily rate:</span>
            <span>{{ settings.dailyPrice | divided_by: 100.0 | round: 2 }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Days:</span>
            <span id="days-display-{{ product.id }}">{{ settings.minDays }}</span>
          </div>
          <hr style="margin: 10px 0; border: none; border-top: 1px solid #d1d5db;">
          <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 18px;">
            <span>Total:</span>
            <span id="total-price-{{ product.id }}">{{ settings.dailyPrice | times: settings.minDays | divided_by: 100.0 | round: 2 }}</span>
          </div>
        </div>

        <div style="display: flex; gap: 10px;">
          <button 
            id="cancel-rental-{{ product.id }}"
            style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; font-weight: 500; cursor: pointer;"
          >
            Cancel
          </button>
          <button 
            id="add-rental-{{ product.id }}"
            style="flex: 1; padding: 12px; background: #059669; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;"
            onmouseover="this.style.background='#047857'" 
            onmouseout="this.style.background='#059669'"
          >
            Add to Cart
          </button>
        </div>
      </div>
    </div>

    <script>
      (function() {
        const productId = {{ product.id }};
        const rentalButton = document.getElementById('rental-btn-' + productId);
        const modal = document.getElementById('rental-modal-' + productId);
        const cancelButton = document.getElementById('cancel-rental-' + productId);
        const addRentalButton = document.getElementById('add-rental-' + productId);
        const daysInput = document.getElementById('rental-days-' + productId);
        const daysDisplay = document.getElementById('days-display-' + productId);
        const totalPriceDisplay = document.getElementById('total-price-' + productId);
        
        const dailyPrice = {{ settings.dailyPrice }};
        const minDays = {{ settings.minDays }};
        const maxDays = {{ settings.maxDays }};

        function updatePrice() {
          const days = parseInt(daysInput.value) || minDays;
          const total = (dailyPrice * days) / 100;
          daysDisplay.textContent = days;
          totalPriceDisplay.textContent = total.toFixed(2);
        }

        rentalButton.addEventListener('click', function() {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        });

        cancelButton.addEventListener('click', function() {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        });

        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
          }
        });

        daysInput.addEventListener('input', updatePrice);

        addRentalButton.addEventListener('click', function() {
          const days = parseInt(daysInput.value) || minDays;
          const rentVariantId = '{{ settings.rentVariantId }}';
          const variantId = rentVariantId.split('/').pop();
          
          const formData = {
            'items': [{
              'id': variantId,
              'quantity': days
            }]
          };

          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          })
          .then(response => response.json())
          .then(data => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            if (window.location.pathname !== '/cart') {
              window.location.href = '/cart';
            } else {
              location.reload();
            }
          })
          .catch(error => {
            console.error('Error adding rental to cart:', error);
            alert('Error adding rental to cart. Please try again.');
          });
        });
      })();
    </script>

{% endif %}
{% else  %}

{% endif %}

<script>
  console.log("the script is wroking ")
  console.log("rentSettings", '{{ rentSettings }}');
</script>

{% schema %}
{
  "name": "Easy Rentals",
  "templates": ["product"],
  "target": "section",
  "settings": [
  ]
}
{% endschema %}

